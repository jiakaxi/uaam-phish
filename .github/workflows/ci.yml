name: CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  # 代码质量检查
  lint:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: Ruff 检查
        run: ruff check .

      - name: Black 格式检查
        run: black --check .

  # 单元测试
  test:
    name: 单元测试
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov

      - name: 运行测试
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term

      - name: 上传覆盖率报告
        if: matrix.python-version == '3.10'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # 数据验证
  validate-data:
    name: 数据 Schema 验证
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyyaml

      - name: 验证数据 Schema
        run: |
          if [ -f "scripts/validate_data_schema.py" ]; then
            python scripts/validate_data_schema.py
          else
            echo "数据验证脚本不存在，跳过"
          fi

  # 配置验证
  validate-configs:
    name: 配置文件验证
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install omegaconf hydra-core pyyaml

      - name: 验证配置文件
        run: |
          python -c "
          from omegaconf import OmegaConf
          import sys
          from pathlib import Path

          errors = []
          for config_file in Path('configs').rglob('*.yaml'):
              try:
                  cfg = OmegaConf.load(config_file)
                  print(f'✅ {config_file}')
              except Exception as e:
                  errors.append(f'❌ {config_file}: {e}')

          if errors:
              for err in errors:
                  print(err)
              sys.exit(1)
          else:
              print('\n✅ 所有配置文件验证通过')
          "

  # 文档检查
  docs-check:
    name: 文档完整性检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 检查 README
        run: |
          if [ ! -f "README.md" ]; then
            echo "❌ README.md 不存在"
            exit 1
          fi
          echo "✅ README.md 存在"

      - name: 检查必要文档
        run: |
          required_docs=("docs/DATA_SCHEMA.md" "docs/ROOT_STRUCTURE.md")
          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "✅ $doc 存在"
            else
              echo "⚠️  $doc 不存在"
            fi
          done

  # 依赖安全检查
  security:
    name: 依赖安全检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 安装 pip-audit
        run: python -m pip install pip-audit

      - name: 运行安全审计
        run: |
          pip-audit --desc || true
