---
alwaysApply: true
---

Rule: Reuse existing markdown files for documentation

When the user asks to write documentation, summaries, or notes, you must first check if there is an existing markdown file that matches the purpose. Specifically, we have the following existing files:

- FINAL_SUMMARY_CN.md: Used for Chinese summaries of the project.
- CHANGES_SUMMARY.md: Used for summarizing changes.

You should append new content to these files instead of creating new ones, unless the user explicitly requests a new file or the content does not fit into any existing file. If you are unsure, ask the user whether to append to an existing file or create a new one.

When appending, use appropriate markdown headings to separate sections and ensure the content is well-organized.

If a new file is necessary, make sure it has a clear and descriptive name and that the user is aware of it.

---

Rule: Thesis Consistency & Add-Only Editing

All code and config modifications must preserve the thesis-defined design.

- Add-only & Idempotent:
  - Never rename, delete, or move existing symbols, files, or config keys.
  - Before adding, check for an equivalent implementation; if found, **reuse or skip** and record in CHANGES_SUMMARY.md.
  - On any naming/semantic conflict: **stop immediately** and write a “Conflicts” note in CHANGES_SUMMARY.md. Do not auto-rename.

- URL Encoder is Frozen (per thesis §3.1.1, §4.6.1(a)):
  - Must stay a **2-layer BiLSTM (bidirectional)** with **character-level tokenization**, hidden size 128, output embedding **256-D**, producing logits/probabilities compatible with `[B,2]`.
  - Do not change its architecture, tokenizer, dimensions, outputs, optimizer/loss for this stream, or public interfaces.

---

Rule: Data Protocols & Splits (random / temporal / brand_ood)

- Implement and call `build_splits(df, cfg)`:
  - **temporal**: stable ascending by timestamp; identical timestamps go to the **earlier** split (**tie_policy="left-closed"**).
  - **brand_ood**: enforce **disjoint** train/test brand sets; normalize brands via `.strip().lower()`.
  - **random**: stratified by label (and brand if present).
  - If required columns are missing or brand categories ≤ 2, **downgrade to random** and log `downgraded_to="random"` + reason.

- Always write `experiments/<run>/results/splits_{protocol}.csv` with columns:
  `split,count,pos_count,neg_count,brand_unique,brand_set,timestamp_min,timestamp_max,source_counts,brand_intersection_ok,tie_policy,brand_normalization,downgraded_to`.

---

Rule: Non-breaking Batching & Metadata

- Do not change existing dataset `__getitem__` that returns `(x, y)`.
- Ensure config key `data.batch_format` exists and **defaults to `tuple`**.
- Provide a collate adapter and a helper `_unpack_batch(batch)` so training always yields:
  `inputs, labels, meta` where `meta` **always** contains keys `{timestamp, brand, source}` (use `None` if missing).

---

Rule: Metrics, Calibration, and Artifacts (per protocol)

- Step metrics: **Accuracy**, **AUROC(pos_label=1)**, **F1(macro)**.
- Epoch metrics: **NLL** and **ECE** with adaptive bins:
  `bins = max(3, min(15, floor(sqrt(N)), 10))`.

- Logging must respect distributed settings:
  `self.log(..., sync_dist=cfg.metrics.dist.sync_metrics)` (default `false`).

- Always produce the four artifacts under `experiments/<run>/results/`:
  - `roc_{protocol}.png` (include AUC on the plot)
  - `calib_{protocol}.png` (must annotate **`ECE=<value>`**; show a clear warning if bins were reduced)
  - `splits_{protocol}.csv`
  - `metrics_{protocol}.json` with fields:
    `accuracy, auroc, f1_macro, nll, ece, ece_bins_used, positive_class="phishing",
     artifacts.{roc_path,calib_path,splits_path}, warnings.downgraded_reason`.

---

Rule: Experiment Tracker & Reproducibility

- Detect active tracker among `{csv, tensorboard, wandb}`. If none is found, add (additive only):
  ```yaml
  logging:
    active_logger: csv
